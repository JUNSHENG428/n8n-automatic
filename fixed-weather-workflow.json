{
  "name": "æ¯æ—¥å¤©æ°”é¢„æŠ¥æ™ºèƒ½æ¨é€ç³»ç»Ÿ",
  "nodes": [
    {
      "id": "schedule_trigger_1",
      "name": "å®šæ—¶è§¦å‘å™¨",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [200, 300],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyDay",
              "hour": 8,
              "minute": 0
            }
          ]
        }
      }
    },
    {
      "id": "set_config_2",
      "name": "è®¾ç½®é…ç½®å‚æ•°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [400, 300],
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "city",
              "value": "={{ $env.WEATHER_CITY || 'Beijing' }}"
            },
            {
              "name": "language",
              "value": "zh"
            }
          ],
          "number": [
            {
              "name": "retryCount",
              "value": 0
            },
            {
              "name": "maxRetries",
              "value": 3
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "http_weather_3",
      "name": "è·å–å¤©æ°”ä¿¡æ¯",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [600, 300],
      "parameters": {
        "method": "GET",
        "url": "https://api.weatherapi.com/v1/forecast.json",
        "authentication": "none",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $env.WEATHER_API_KEY }}"
            },
            {
              "name": "q", 
              "value": "={{ $json.city }}"
            },
            {
              "name": "days",
              "value": "3"
            },
            {
              "name": "aqi",
              "value": "yes"
            },
            {
              "name": "alerts",
              "value": "yes"
            },
            {
              "name": "lang",
              "value": "={{ $json.language }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "continueOnFail": true
    },
    {
      "id": "if_success_4",
      "name": "æ£€æŸ¥APIå“åº”",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [800, 300],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error ? false : true }}",
              "value2": true
            }
          ]
        }
      }
    },
    {
      "id": "format_weather_5",
      "name": "æ ¼å¼åŒ–å¤©æ°”æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1000, 200],
      "parameters": {
        "jsCode": "const weatherData = items[0].json;\nconst location = weatherData.location;\nconst current = weatherData.current;\nconst forecast = weatherData.forecast.forecastday;\n\n// æ ¼å¼åŒ–å½“å‰å¤©æ°”\nconst currentWeather = {\n  åŸå¸‚: `${location.name}, ${location.country}`,\n  æ›´æ–°æ—¶é—´: new Date(location.localtime).toLocaleString('zh-CN'),\n  æ¸©åº¦: `${current.temp_c}Â°C`,\n  ä½“æ„Ÿæ¸©åº¦: `${current.feelslike_c}Â°C`,\n  å¤©æ°”çŠ¶å†µ: current.condition.text,\n  æ¹¿åº¦: `${current.humidity}%`,\n  é£é€Ÿ: `${current.wind_kph} km/h`,\n  é£å‘: current.wind_dir,\n  èƒ½è§åº¦: `${current.vis_km} km`,\n  ç´«å¤–çº¿æŒ‡æ•°: current.uv,\n  ç©ºæ°”è´¨é‡: current.air_quality ? `PM2.5: ${current.air_quality.pm2_5}` : 'æš‚æ— æ•°æ®'\n};\n\n// æ ¼å¼åŒ–æœªæ¥å¤©æ°”é¢„æŠ¥\nconst forecastData = forecast.map(day => ({\n  æ—¥æœŸ: new Date(day.date).toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }),\n  æœ€é«˜æ¸©åº¦: `${day.day.maxtemp_c}Â°C`,\n  æœ€ä½æ¸©åº¦: `${day.day.mintemp_c}Â°C`,\n  å¤©æ°”: day.day.condition.text,\n  é™é›¨æ¦‚ç‡: `${day.day.daily_chance_of_rain}%`,\n  æ—¥å‡º: day.astro.sunrise,\n  æ—¥è½: day.astro.sunset\n}));\n\n// ç”Ÿæˆå»ºè®®\nconst suggestions = [];\nif (current.temp_c < 10) suggestions.push('ğŸ§¥ ä»Šå¤©è¾ƒå†·ï¼Œè¯·æ³¨æ„ä¿æš–');\nif (current.temp_c > 30) suggestions.push('ğŸŒ ä»Šå¤©è¾ƒçƒ­ï¼Œè¯·æ³¨æ„é˜²æ™’');\nif (forecast[0].day.daily_chance_of_rain > 50) suggestions.push('â˜” ä»Šå¤©å¯èƒ½ä¸‹é›¨ï¼Œè¯·æºå¸¦é›¨å…·');\nif (current.uv > 6) suggestions.push('ğŸ•¶ï¸ ç´«å¤–çº¿è¾ƒå¼ºï¼Œå»ºè®®æ¶‚æŠ¹é˜²æ™’éœœ');\n\nreturn [{\n  json: {\n    currentWeather,\n    forecastData,\n    suggestions,\n    alerts: weatherData.alerts?.alert || []\n  }\n}];"
      }
    },
    {
      "id": "generate_email_6",
      "name": "ç”Ÿæˆé‚®ä»¶å†…å®¹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1200, 200],
      "parameters": {
        "jsCode": "const data = items[0].json;\nconst { currentWeather, forecastData, suggestions, alerts } = data;\n\n// ç”ŸæˆHTMLé‚®ä»¶å†…å®¹\nlet htmlContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }\n    .content { background-color: #f9f9f9; padding: 20px; border-radius: 0 0 10px 10px; }\n    .weather-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n    .forecast-item { display: inline-block; margin: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; }\n    .suggestion { padding: 10px; margin: 5px 0; background: #fff3cd; border-left: 4px solid #ffc107; }\n    .alert { padding: 10px; margin: 10px 0; background: #f8d7da; border-left: 4px solid #dc3545; }\n    table { width: 100%; border-collapse: collapse; }\n    td { padding: 8px; border-bottom: 1px solid #ddd; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>ğŸ“ ${currentWeather.åŸå¸‚} - ä»Šæ—¥å¤©æ°”é¢„æŠ¥</h1>\n      <p>${currentWeather.æ›´æ–°æ—¶é—´}</p>\n    </div>\n    <div class=\"content\">\n      <div class=\"weather-card\">\n        <h2>ğŸŒ¡ï¸ å½“å‰å¤©æ°”</h2>\n        <table>\n          <tr><td><strong>æ¸©åº¦ï¼š</strong></td><td>${currentWeather.æ¸©åº¦} (ä½“æ„Ÿ ${currentWeather.ä½“æ„Ÿæ¸©åº¦})</td></tr>\n          <tr><td><strong>å¤©æ°”ï¼š</strong></td><td>${currentWeather.å¤©æ°”çŠ¶å†µ}</td></tr>\n          <tr><td><strong>æ¹¿åº¦ï¼š</strong></td><td>${currentWeather.æ¹¿åº¦}</td></tr>\n          <tr><td><strong>é£å†µï¼š</strong></td><td>${currentWeather.é£å‘} ${currentWeather.é£é€Ÿ}</td></tr>\n          <tr><td><strong>èƒ½è§åº¦ï¼š</strong></td><td>${currentWeather.èƒ½è§åº¦}</td></tr>\n          <tr><td><strong>ç´«å¤–çº¿ï¼š</strong></td><td>${currentWeather.ç´«å¤–çº¿æŒ‡æ•°}</td></tr>\n          <tr><td><strong>ç©ºæ°”è´¨é‡ï¼š</strong></td><td>${currentWeather.ç©ºæ°”è´¨é‡}</td></tr>\n        </table>\n      </div>\n`;\n\n// æ·»åŠ æœªæ¥å¤©æ°”é¢„æŠ¥\nhtmlContent += `\n      <div class=\"weather-card\">\n        <h2>ğŸ“… æœªæ¥ä¸‰å¤©é¢„æŠ¥</h2>\n`;\n\nforecastData.forEach(day => {\n  htmlContent += `\n        <div class=\"forecast-item\">\n          <strong>${day.æ—¥æœŸ}</strong><br>\n          ğŸŒ¡ï¸ ${day.æœ€ä½æ¸©åº¦} - ${day.æœ€é«˜æ¸©åº¦}<br>\n          ${day.å¤©æ°”}<br>\n          ğŸ’§ é™é›¨æ¦‚ç‡: ${day.é™é›¨æ¦‚ç‡}<br>\n          ğŸŒ… ${day.æ—¥å‡º} - ğŸŒ† ${day.æ—¥è½}\n        </div>\n  `;\n});\n\nhtmlContent += '</div>';\n\n// æ·»åŠ å»ºè®®\nif (suggestions.length > 0) {\n  htmlContent += '<div class=\"weather-card\"><h2>ğŸ’¡ ä»Šæ—¥å»ºè®®</h2>';\n  suggestions.forEach(suggestion => {\n    htmlContent += `<div class=\"suggestion\">${suggestion}</div>`;\n  });\n  htmlContent += '</div>';\n}\n\n// æ·»åŠ å¤©æ°”é¢„è­¦\nif (alerts.length > 0) {\n  htmlContent += '<div class=\"weather-card\"><h2>âš ï¸ å¤©æ°”é¢„è­¦</h2>';\n  alerts.forEach(alert => {\n    htmlContent += `<div class=\"alert\"><strong>${alert.headline}</strong><br>${alert.desc}</div>`;\n  });\n  htmlContent += '</div>';\n}\n\nhtmlContent += `\n    </div>\n  </div>\n</body>\n</html>\n`;\n\n// ç”Ÿæˆçº¯æ–‡æœ¬ç‰ˆæœ¬\nlet textContent = `${currentWeather.åŸå¸‚} - ä»Šæ—¥å¤©æ°”é¢„æŠ¥\\n\\n`;\ntextContent += `å½“å‰å¤©æ°”ï¼š\\n`;\ntextContent += `æ¸©åº¦: ${currentWeather.æ¸©åº¦} (ä½“æ„Ÿ ${currentWeather.ä½“æ„Ÿæ¸©åº¦})\\n`;\ntextContent += `å¤©æ°”: ${currentWeather.å¤©æ°”çŠ¶å†µ}\\n`;\ntextContent += `æ¹¿åº¦: ${currentWeather.æ¹¿åº¦}\\n`;\ntextContent += `é£å†µ: ${currentWeather.é£å‘} ${currentWeather.é£é€Ÿ}\\n\\n`;\n\ntextContent += `æœªæ¥ä¸‰å¤©é¢„æŠ¥ï¼š\\n`;\nforecastData.forEach(day => {\n  textContent += `\\n${day.æ—¥æœŸ}\\n`;\n  textContent += `æ¸©åº¦: ${day.æœ€ä½æ¸©åº¦} - ${day.æœ€é«˜æ¸©åº¦}\\n`;\n  textContent += `å¤©æ°”: ${day.å¤©æ°”}\\n`;\n  textContent += `é™é›¨æ¦‚ç‡: ${day.é™é›¨æ¦‚ç‡}\\n`;\n});\n\nif (suggestions.length > 0) {\n  textContent += `\\nä»Šæ—¥å»ºè®®ï¼š\\n`;\n  suggestions.forEach(suggestion => {\n    textContent += `- ${suggestion}\\n`;\n  });\n}\n\nreturn [{\n  json: {\n    subject: `ğŸ“ ${currentWeather.åŸå¸‚} - ${currentWeather.å¤©æ°”çŠ¶å†µ} ${currentWeather.æ¸©åº¦}`,\n    htmlContent,\n    textContent,\n    toEmail: `{{ $env.RECIPIENT_EMAIL || 'user@example.com' }}`\n  }\n}];"
      }
    },
    {
      "id": "send_email_7",
      "name": "å‘é€é‚®ä»¶",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1400, 200],
      "parameters": {
        "fromEmail": "={{ $env.SMTP_FROM_EMAIL || 'weather@yourdomain.com' }}",
        "toEmail": "={{ $json.toEmail }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "message": "={{ $json.htmlContent }}",
        "options": {
          "allowUnauthorizedCerts": true
        }
      }
    },
    {
      "id": "wait_retry_9",
      "name": "ç­‰å¾…é‡è¯•",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [800, 500],
      "parameters": {
        "resume": "timeInterval",
        "amount": 30,
        "unit": "seconds"
      }
    },
    {
      "id": "increment_retry_10",
      "name": "å¢åŠ é‡è¯•æ¬¡æ•°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [1000, 500],
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "city",
              "value": "={{ $json.city }}"
            },
            {
              "name": "language",
              "value": "={{ $json.language }}"
            }
          ],
          "number": [
            {
              "name": "retryCount",
              "value": "={{ $json.retryCount + 1 }}"
            },
            {
              "name": "maxRetries",
              "value": "={{ $json.maxRetries }}"
            }
          ]
        },
        "options": {}
      }
    },
    {
      "id": "check_retry_11",
      "name": "æ£€æŸ¥é‡è¯•æ¬¡æ•°",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1200, 500],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.retryCount < $json.maxRetries }}",
              "value2": true
            }
          ]
        }
      }
    },
    {
      "id": "error_notification_12",
      "name": "å‘é€é”™è¯¯é€šçŸ¥",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1400, 600],
      "parameters": {
        "fromEmail": "={{ $env.SMTP_FROM_EMAIL || 'system@yourdomain.com' }}",
        "toEmail": "={{ $env.ADMIN_EMAIL || 'admin@yourdomain.com' }}",
        "subject": "âŒ å¤©æ°”é¢„æŠ¥å·¥ä½œæµæ‰§è¡Œå¤±è´¥",
        "emailType": "text",
        "message": "å¤©æ°”é¢„æŠ¥å·¥ä½œæµæ‰§è¡Œå¤±è´¥\n\né”™è¯¯è¯¦æƒ…ï¼š\n{{ $('è·å–å¤©æ°”ä¿¡æ¯').item.json.error || 'æœªçŸ¥é”™è¯¯' }}\n\nåŸå¸‚ï¼š{{ $json.city }}\né‡è¯•æ¬¡æ•°ï¼š{{ $json.retryCount }}\n\nè¯·æ£€æŸ¥ï¼š\n1. Weather APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. APIé…é¢æ˜¯å¦å……è¶³",
        "options": {}
      }
    },
    {
      "id": "log_error_13",
      "name": "è®°å½•é”™è¯¯æ—¥å¿—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1600, 600],
      "parameters": {
        "jsCode": "console.error('Weather workflow failed:', {\n  city: items[0].json.city,\n  retryCount: items[0].json.retryCount,\n  error: items[0].json.error || 'Unknown error',\n  timestamp: new Date().toISOString()\n});\n\nreturn [{\n  json: {\n    status: 'failed',\n    timestamp: new Date().toISOString()\n  }\n}];"
      }
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "è®¾ç½®é…ç½®å‚æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è®¾ç½®é…ç½®å‚æ•°": {
      "main": [
        [
          {
            "node": "è·å–å¤©æ°”ä¿¡æ¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–å¤©æ°”ä¿¡æ¯": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥APIå“åº”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥APIå“åº”": {
      "main": [
        [
          {
            "node": "æ ¼å¼åŒ–å¤©æ°”æ•°æ®",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ç­‰å¾…é‡è¯•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ¼å¼åŒ–å¤©æ°”æ•°æ®": {
      "main": [
        [
          {
            "node": "ç”Ÿæˆé‚®ä»¶å†…å®¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç”Ÿæˆé‚®ä»¶å†…å®¹": {
      "main": [
        [
          {
            "node": "å‘é€é‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€é‚®ä»¶": {
      "main": []
    },
    "ç­‰å¾…é‡è¯•": {
      "main": [
        [
          {
            "node": "å¢åŠ é‡è¯•æ¬¡æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¢åŠ é‡è¯•æ¬¡æ•°": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥é‡è¯•æ¬¡æ•°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥é‡è¯•æ¬¡æ•°": {
      "main": [
        [
          {
            "node": "è·å–å¤©æ°”ä¿¡æ¯",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "å‘é€é”™è¯¯é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€é”™è¯¯é€šçŸ¥": {
      "main": [
        [
          {
            "node": "è®°å½•é”™è¯¯æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "saveDataSuccessExecution": "all",
    "executionTimeout": 300,
    "timezone": "Asia/Shanghai"
  },
  "staticData": null,
  "tags": [],
  "active": false
} 